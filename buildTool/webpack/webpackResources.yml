app: {}

build:
  packages:
    - <<: *pkg_webpack
    - <<: *pkg_webpack-dev-server
    - <<: *pkg_lodash   # Used by the webpack-dev-server

  tasks:
    - name: build:dev
      tasks: ['webpack-dev-server --progress --config <%= paths.config.configDir %>webpack/dev.webpack.config.js --hot']
      description: Create a development build using Webpack
      features:
        - Sourcemaps
        - Hot reloading of source code
    - name: build:prod
      tasks: ['webpack -p --progress --config <%= paths.config.configDir %>webpack/prod.webpack.config.js']
      description: Create a production build using Webpack
      features:
        - Minifies source code
        - Sourcemaps
        - Dead code removal
        - Hashes added to file names for cache-busting


buildAssets:
  packages:
    - <<: *pkg_file-loader

buildCSS:
  # Common packages
  packages:
    - <<: *pkg_css-loader
    - <<: *pkg_style-loader
    - <<: *pkg_autoprefixer
    - <<: *pkg_postcss-loader

  sourceFormat:
    css:
      packages: []

    stylus:
      packages:
        - <<: *pkg_stylus-loader

    sass:
      packages:
        - <<: *pkg_sass-loader
        - <<: *pkg_node-sass

buildHTML:
  packages:
    - <<: *pkg_html-loader
    - <<: *pkg_html-webpack-plugin

buildJS:
  sourceFormat:
    ES6:
      packages:
        - <<: *pkg_babel-core
        - <<: *pkg_babel-runtime
        - <<: *pkg_babel-loader
        - <<: *pkg_babel-preset-es2015
        - <<: *pkg_babel-plugin-add-module-exports    # Adds export for the "default" export: module.exports = exports['default']; See http://stackoverflow.com/questions/34736771/webpack-umd-library-return-object-default/34778391#34778391

    ES5:
      packages: []

    TypeScript:
      packages:
        - <<: *pkg_ts-loader


# sampleApp configuration
sampleApp:
  js:
    framework:
      '':
        sampleDir: noFramework/
        vendorScripts: []
        typeLibs: []
        sourceFormat:
          ES6:
            hasSampleApp: true
          TypeScript:
            hasSampleApp: true

      AngularJS 1.x:
        sampleDir: ng1/
        vendorScripts:
          - <<: *pkg_angular-route
        testVendorScripts:
          - <<: *pkg_angular-route
        typeLibs:
          - name: angular-route
            key: ambientDependencies
            version: github:DefinitelyTyped/DefinitelyTyped/angularjs/angular-route.d.ts#cf172aab99c3139a718aa8e65398a22c53dd7ead
        sourceFormat:
          ES6:
            hasSampleApp: true
          TypeScript:
            hasSampleApp: true

      AngularJS 2.x:
        sampleDir: ng2/
        vendorScripts:
          - <<: *pkg_angular2/router
          - <<: *pkg_angular2/platform/browser
        typeLibs: []

        sourceFormat:
          TypeScript:
            hasSampleApp: true
            testUnitConfig: |
              // Load Angular 2's Jasmine helper methods:
              var testing = require('angular2/testing');
              var browser = require('angular2/platform/testing/browser');

              testing.setBaseTestProviders(
                browser.TEST_BROWSER_PLATFORM_PROVIDERS,
                browser.TEST_BROWSER_APPLICATION_PROVIDERS
              );
            vendorScripts:  # Generates adds the item to the vendor scripts
              pre:
                - './polyfills.ts'
              post: []
          ES6:
            hasSampleApp: true

      React (latest):
        sampleDir: react/
        vendorScripts: []
        typeLibs: []
        sourceFormat: {}

serverDev: {}

testUnit:
  # Use different coverage loaders for TypeScript as there currently isn't a loader that understands TypeScript natively?
  sourceFormat:
    ES5:
      loaderType: preLoaders
      loaderName: isparta-instrumenter-loader
      packages:
        - <<: *pkg_isparta-instrumenter-loader

    ES6:
      loaderType: preLoaders
      loaderName: isparta-instrumenter-loader
      query:
        babel:
          presets: ['es2015']
      packages:
        - <<: *pkg_isparta-instrumenter-loader

    TypeScript:
      loaderType: postLoaders
      loaderName: istanbul-instrumenter-loader
      packages:
        - <<: *pkg_istanbul-instrumenter-loader

  packages:
    - <<: *pkg_karma
    - <<: *pkg_karma-chrome-launcher
    - <<: *pkg_karma-coverage
    - <<: *pkg_karma-jasmine
    - <<: *pkg_karma-junit-reporter
    - <<: *pkg_karma-ng-html2js-preprocessor   # TODO: Shouldn't this be conditional? Or is it even needed with Webpack, if you require() HTML templates?
    - <<: *pkg_karma-phantomjs-launcher
    - <<: *pkg_karma-sourcemap-loader
    - <<: *pkg_karma-spec-reporter
    - <<: *pkg_karma-threshold-reporter
    - <<: *pkg_karma-webpack
    - <<: *pkg_jasmine-core
    - <<: *pkg_phantomjs-prebuilt
    - <<: *pkg_phantomjs-polyfill

  tasks:
    - name: test
      tasks: ['npm run test:unit']
      description: Alias for `npm run test:unit` task
      features: []

    - name: test:unit
      tasks: ['karma start ./<%= paths.config.configDir %>testUnit/karma.conf.js']
      description: Run unit tests whenever JS source or tests change
      features:
        - Uses Karma and Jasmine 2
        - Code coverage
        - Runs continuously (best to run in a separate window)

    - name: test:unit:once
      tasks: ['karma start --singleRun=true ./<%= paths.config.configDir %>testUnit/karma.conf.js']
      description: Run unit tests once
      features:

    - name: test:unit:debug
      tasks: ['karma start ./<%= paths.config.configDir %>testUnit/karma.conf.js --debug']
      description: Run unit tests but disable code coverage to make debugging in a browser easier
      features:
        - no code coverage to make it easier to read source code

  typeLibs:
    - name: jasmine
      key: ambientDependencies
      version: github:DefinitelyTyped/DefinitelyTyped/jasmine/jasmine.d.ts#4b36b94d5910aa8a4d20bdcd5bd1f9ae6ad18d3c

  templateFiles:
    - src: karma.conf.js
      dest: <%= paths.config.configDir %>testUnit/karma.conf.js
      overwrite: true

    - src: karma.common.js.tpl
      dest: <%= paths.config.configDir %>testUnit/karma.common.js
      overwrite: true

    - src: test.files.js.tpl
      dest: <%= paths.config.configDir %>testUnit/test.files.js
      overwrite: true


  readme:
    extensionPoint:
      testUnit: >
        `npm test:unit` can be extended by modifying
        <%= link(paths.config.configDir + 'testUnit/karma.conf.js') %> and <%= link(paths.config.configDir + 'testUnit/karma.common.js') %>.
        <%= link(paths.config.configDir + 'testUnit/test.files.js') %> is generated from the entry points in the Confit configuration.
        It is **best** to modify the entry points in <%= link(configFile) %> then re-run `yo confit`.

zzfinish:
  packages:
    - <<: *pkg_extract-text-webpack-plugin

  templateFiles:
    - src: webpack.config.js.tpl
      dest: <%= paths.config.configDir %>webpack/webpack.config.js
      overwrite: true

    - src: dev.webpack.config.js
      dest: <%= paths.config.configDir %>webpack/dev.webpack.config.js
      overwrite: true

    - src: prod.webpack.config.js
      dest: <%= paths.config.configDir %>webpack/prod.webpack.config.js
      overwrite: true

  readme:
    extensionPoint:
      start: >
        `npm start` can be extended by modifying <%= link(paths.config.configDir + 'webpack/dev.webpack.config.js') %>
        and <%= link(paths.config.configDir + 'webpack/prod.webpack.config.js') %>. Confit will attempt to overwrite the contents
        files the next time `yo confit` is run, so make sure any modifications are committed to source control first.

  onEnd:
    - cmd: npm
      args: ['start']
